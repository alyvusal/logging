# https://docs.fluentd.org/configuration/config-file
# https://www.fluentd.org/plugins

##################################################################
#                         Source
##################################################################
# determine the input sources (where all the data comes from)
# https://docs.fluentd.org/configuration/config-file#id-1.-source-where-all-the-data-comes-from
# @type: (required) input plugin to use.
# standard input plugins include http and forward
# input plugins: https://docs.fluentd.org/input

# HTTP input
# POST http://localhost:8888/<tag>?json=<json>
# http://<ip>:9880/myapp.access?json={"event":"data"}
# curl -X POST -d 'json={"json":"message"}' http://localhost:8888/debug.test
# POST http://localhost:8888/td.myapp.login?json={"user"%3A"me"}
# <source>
#   @type http
#   @id input_http
#   port 8888
# </source>

## built-in TCP input
# Receive events from 24224/tcp
# This is used by log forwarding and the fluent-cat command
# $ echo <json> | fluent-cat <tag>
<source>
  @type  forward
  @id    input_forward
  # @label @mainstream
  add_tag_prefix lab
  port   24224  # default port, line could be commented
</source>

# to /etc/rsyslog.conf add:
# *.* @127.0.0.1:5140
# systemctl restart rsyslog
# <source>
#   @type  syslog
#   tag    syslog.system
#   port   5140
# </source>

## live debugging agent
# Listen DRb for debug
# <source>
#   @type debug_agent
#   @id debug_agent
#   bind 127.0.0.1
#   port 24230
# </source>

# curl 127.0.0.1:24220/api/plugins.json
<source>
  @type monitor_agent
  @id monitor_agent
  port 24220
</source>

## built-in UNIX socket input
#<source>
#  type unix
#</source>

## File input
## read apache logs with tag=apache.access
#<source>
#  @type tail
#  format apache
#  path /var/log/httpd-access.log
#  tag apache.access
#</source>

## File input
## read apache logs continuously and tags td.apache.access
#<source>
#  @type tail
#  @id input_tail
#  <parse>
#    @type apache2
#  </parse>
#  path /var/log/httpd-access.log
#  tag td.apache.access
#</source>


##################################################################
#                         Filter
##################################################################
# determine the event processing pipelines
# https://docs.fluentd.org/configuration/config-file#id-3.-filter-event-processing-pipeline
# Sits between source and match directives, similar syntax like match directive

## Mutating event filter
## Add hostname and tag fields to apache.access tag events
#<filter apache.access>
#  @type record_transformer
#  <record>
#    hostname ${hostname}
#    tag ${tag}
#  </record>
#</filter>

## Selecting event filter
## Remove unnecessary events from apache prefixed tag events
#<filter apache.**>
#  @type grep
#  include1 method GET # pass only GET in 'method' field
#  exclude1 message debug # remove debug event
#</filter>


##################################################################
#                         Match
##################################################################
# determine the output destinations (Tell fluentd what to do!)
# https://docs.fluentd.org/configuration/config-file#id-2.-match-tell-fluentd-what-to-do
# The match directive looks for events with matching tags and processes them
# The most common use of the match directive is to output events to other systems
# @type: (required) output plugin to use.
# standard output plugins include file and forward
# output plugins: https://docs.fluentd.org/output

## match tag=debug.** and dump to console
# <match debug.**>
#   @type stdout
#   @id output_stdout
# </match>

# do sudo command on host and see logs
# <match system.**>
#   @type stdout
# </match>

<match lab.*>
  @type stdout
</match>

# <filter **>
#   @type stdout
# </filter>

## match fluent's internal events
#<match fluent.**>
#  @type null
#</match>

## match not matched logs and write to file
#<match **>
#  @type file
#  path /var/log/fluent/else
#  compress gz
#</match>

# Treasure Data (http://www.treasure-data.com/) provides cloud based data
# analytics platform, which easily stores and processes data from td-agent.
# FREE plan is also provided.
# @see http://docs.fluentd.org/articles/http-to-td
#
# This section matches events whose tag is td.DATABASE.TABLE
# <match td.*.*>
#   @type tdlog
#   @id output_td
#   apikey YOUR_API_KEY

#   auto_create_table
#   <buffer>
#     @type file
#     path /var/log/fluent/buffer/td
#   </buffer>

#   <secondary>
#     @type secondary_file
#     directory /var/log/fluent/failed_records
#   </secondary>
# </match>

## File output
## match tag=local.** and write to file
#<match local.**>
#  @type file
#  @id output_file
#  path /var/log/fluent/access
#</match>

## Forwarding
## match tag=system.** and forward to another fluentd server
#<match system.**>
#  @type forward
#  @id output_system_forward
#
#  <server>
#    host 192.168.0.11
#  </server>
#  # secondary host is optional
#  <secondary>
#    <server>
#      host 192.168.0.12
#    </server>
#  </secondary>
#</match>

## Multiple output
## match tag=td.*.* and output to Treasure Data AND file
#<match td.*.*>
#  @type copy
#  @id output_copy
#  <store>
#    @type tdlog
#    apikey API_KEY
#    auto_create_table
#    <buffer>
#      @type file
#      path /var/log/fluent/buffer/td
#    </buffer>
#  </store>
#  <store>
#    @type file
#    path /var/log/fluent/td-%Y-%m-%d/%H.log
#  </store>
#</match>

## match tag=system.** and forward to another fluent server
#<match system.**>
#  @type forward
#  @id forward_output
#
#  <server>
#    host 192.168.0.11
#  </server>
#  <secondary>
#    <server>
#      host 192.168.0.12
#    </server>
#  </secondary>
#</match>

## match tag=myapp.** and forward and write to file
#<match myapp.**>
#  @type copy
#  <store>
#    @type forward
#    buffer_type file
#    buffer_path /var/log/fluent/myapp-forward
#    retry_limit 50
#    flush_interval 10s
#    <server>
#      host 192.168.0.13
#    </server>
#  </store>
#  <store>
#    @type file
#    path /var/log/fluent/myapp
#  </store>
#</match>


##################################################################
#                         Label
##################################################################
# group the output and filter for internal routing
# https://docs.fluentd.org/configuration/config-file#id-5.-group-filter-and-output-the-label-directive
# The label directive groups filter and output for internal routing. The label reduces the complexity of tag handling.

# <label @mainstream>
#   <match docker.**>
#     @type file
#     @id   output_docker1
#     path         /fluentd/log/docker.*.log
#     symlink_path /fluentd/log/docker.log
#     append       true
#     time_slice_format %Y%m%d
#     time_slice_wait   1m
#     time_format       %Y%m%dT%H%M%S%z
#   </match>
#   <match **>
#     @type file
#     @id   output1
#     path         /fluentd/log/data.*.log
#     symlink_path /fluentd/log/data.log
#     append       true
#     time_slice_format %Y%m%d
#     time_slice_wait   10m
#     time_format       %Y%m%dT%H%M%S%z
#   </match>
# </label>

#<label @STAGING>
#  <match system.**>
#    @type forward
#    @id staging_forward_output
#    <server>
#      host 192.168.0.101
#    </server>
#  </match>
#</label>
## match tag=apache.access and write to file
#<match apache.access>
#  @type file
#  path /var/log/fluent/access
#</match>


##################################################################
#                         System
##################################################################
# System-wide configurations
# https://docs.fluentd.org/configuration/config-file#id-4.-set-system-wide-configuration-the-system-directive
# https://docs.fluentd.org/deployment/system-config

<system>
  process_name fluentd
</system>

# <system>
#   # equal to -qq option
#   log_level error
#   # equal to --without-source option
#   without_source
#   # ...
# </system>


##################################################################
#                         Worker
##################################################################
# limit to the specific workers
# https://docs.fluentd.org/configuration/config-file#id-6.-limit-to-specific-workers-the-worker-directive
# When setting up multiple workers, limit plugins to run on specific workers

# <system>
#   workers 4
# </system>

# <worker 0-1>
#   <source>
#     @type sample
#     tag test.someworkers
#     sample {"message": "Run with worker-0 and worker-1."}
#   </source>
# </worker>


##################################################################
#                         Includes
##################################################################
# include other files
# https://docs.fluentd.org/configuration/config-file#id-7.-reuse-your-config-the-include-directive

# absolute path
# @include /path/to/config.conf

# # if using a relative path, the directive will use
# # the dirname of this config file to expand the path
# @include extra.conf

# # glob match pattern
# @include config.d/*.conf

# per source
# <source>
# @include http://example.com/fluent.conf
# </source>
